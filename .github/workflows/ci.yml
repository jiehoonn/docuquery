# =============================================================================
# DocuQuery CI Pipeline
#
# Runs on every push and PR to main:
#   1. Lint code (black, isort)
#   2. Run unit tests (pytest)
#   3. Build Docker image
# =============================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: pip install poetry

      - name: Install dependencies
        run: poetry install --with dev --no-interaction

      - name: Check formatting (black)
        run: poetry run black --check app/ tests/

      - name: Check import sorting (isort)
        run: poetry run isort --check-only app/ tests/

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: pip install poetry

      - name: Install dependencies
        run: poetry install --with dev --no-interaction

      - name: Run unit tests
        env:
          # Dummy values â€” unit tests mock all external services,
          # but Settings requires DATABASE_URL to exist at import time
          DATABASE_URL: "postgresql+asyncpg://test:test@localhost:5432/test"
        run: poetry run pytest tests/unit/ -v

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [lint, test]  # Only build if lint + tests pass
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t docuquery .